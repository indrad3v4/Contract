{% extends "base.html" %}

{% block title %}DAODISEO - AI Brain Orchestrator Dashboard{% endblock %}

{% block extra_css %}
<!-- Liquid Glass Design System -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/liquid-glass-system.css') }}">
<!-- Enhanced Chat CSS -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/chat-enhanced.css') }}">
{% endblock %}

{% block content %}
<div class="dashboard route-glass-container">
    <!-- State Sync Indicator -->
    <div class="state-sync-indicator synced" id="stateSyncIndicator">
        All systems synced
    </div>
    
    <!-- AI Brain Central Hub -->
    <div class="ai-brain-central-hub component-glass-panel mb-4">
        <div class="brain-visualization">
            <div class="brain-connections" id="neuralConnections"></div>
        </div>
        
        <div class="mt-3">
            <h3 class="text-center mb-2">DAODISEO AI Brain</h3>
            <p class="text-center text-muted">Central Intelligence Orchestrator</p>
        </div>
        
        <!-- AI Insights Panel -->
        <div class="brain-insights-panel mt-4">
            <div class="row">
                <div class="col-md-6">
                    <div class="subcomponent-glass-element p-3">
                        <h6>Predictive Insights</h6>
                        <div id="ai-insights-container">
                            <div class="status-ribbon processing">
                                <span>Analyzing portfolio optimization opportunities</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="subcomponent-glass-element p-3">
                        <h6>Risk Assessment</h6>
                        <div class="progress-with-action">
                            <div class="progress-bar-glass">
                                <div class="progress-fill" style="width: 75%"></div>
                            </div>
                            <div class="next-action">
                                <i data-feather="shield" class="icon-inline-sm"></i>
                                Portfolio risk: Low
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Satellite Orbital Components -->
    <div class="satellite-container">
        <!-- Top-Left: Asset Distribution -->
        <div class="satellite-component satellite-top-left" data-satellite="assets">
            <div class="status-ribbon verified mb-3">
                <i data-feather="pie-chart" class="icon-inline-sm"></i>
                Asset Distribution
            </div>
            
            <div class="subcomponent-glass-element p-3">
                <div class="chart-container" style="height: 200px;">
                    <canvas id="asset-distribution-chart"></canvas>
                </div>
                <div class="d-flex justify-content-between mt-3">
                    <div class="text-center">
                        <div class="small text-muted">Verified Assets</div>
                        <div class="fw-bold text-success" id="verified-assets-value">$24,250,000</div>
                    </div>
                    <div class="text-center">
                        <div class="small text-muted">Pipeline</div>
                        <div class="fw-bold text-warning" id="pending-assets-value">$13,876,500</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Top-Right: ODIS Token Metrics -->
        <div class="satellite-component satellite-top-right" data-satellite="token">
            <div class="status-ribbon verified mb-3">
                <i data-feather="trending-up" class="icon-inline-sm"></i>
                ODIS Token Metrics
            </div>
            
            <div class="subcomponent-glass-element p-3">
                <div class="row g-2">
                    <div class="col-6">
                        <div class="metric-small">
                            <div class="metric-value" id="token-price">$0.1214</div>
                            <div class="metric-label">Price</div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="metric-small">
                            <div class="metric-value text-success" id="price-change">+3.68%</div>
                            <div class="metric-label">24h Change</div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="metric-small">
                            <div class="metric-value" id="market-cap">$12.4M</div>
                            <div class="metric-label">Market Cap</div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="metric-small">
                            <div class="metric-value" id="staking-apy">9.5%</div>
                            <div class="metric-label">Staking APY</div>
                        </div>
                    </div>
                </div>
                
                <div class="progress-with-action mt-3">
                    <div class="next-action">
                        <i data-feather="arrow-up" class="icon-inline-sm"></i>
                        Stake for rewards
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Bottom-Left: Validators Network -->
        <div class="satellite-component satellite-bottom-left" data-satellite="validators">
            <div class="status-ribbon processing mb-3">
                <i data-feather="server" class="icon-inline-sm"></i>
                Validators Network
            </div>
            
            <div class="subcomponent-glass-element p-3">
                <div class="row g-2 mb-3">
                    <div class="col-4">
                        <div class="metric-small">
                            <div class="metric-value text-success" id="active-validators">10</div>
                            <div class="metric-label">Active</div>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="metric-small">
                            <div class="metric-value" id="total-staked">$2.1M</div>
                            <div class="metric-label">Staked</div>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="metric-small">
                            <div class="metric-value text-info" id="avg-commission">5.2%</div>
                            <div class="metric-label">Avg Fee</div>
                        </div>
                    </div>
                </div>
                
                <div class="progress-with-action">
                    <div class="progress-bar-glass">
                        <div class="progress-fill" style="width: 88%"></div>
                    </div>
                    <div class="next-action">
                        <i data-feather="users" class="icon-inline-sm"></i>
                        View all validators
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Bottom-Right: Transaction History -->
        <div class="satellite-component satellite-bottom-right" data-satellite="transactions">
            <div class="status-ribbon pending mb-3">
                <i data-feather="activity" class="icon-inline-sm"></i>
                Recent Activity
            </div>
            
            <div class="subcomponent-glass-element p-3">
                <div class="transaction-list" id="recent-transactions">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div class="d-flex align-items-center">
                            <div class="status-indicator active me-2"></div>
                            <span class="small">Property Tokenization</span>
                        </div>
                        <span class="small text-success">+1250 ODIS</span>
                    </div>
                    
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div class="d-flex align-items-center">
                            <div class="status-indicator jailed me-2"></div>
                            <span class="small">Contract Signature</span>
                        </div>
                        <span class="small text-muted">Pending</span>
                    </div>
                    
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center">
                            <div class="status-indicator active me-2"></div>
                            <span class="small">Token Transfer</span>
                        </div>
                        <span class="small text-warning">-350 ODIS</span>
                    </div>
                </div>
                
                <div class="progress-with-action mt-3">
                    <div class="next-action">
                        <i data-feather="list" class="icon-inline-sm"></i>
                        View all transactions
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Portfolio Overview - Redesigned as Unified Glass Panel -->
    <div class="component-glass-panel mb-4">
        <div class="d-flex justify-content-between align-items-center p-3 border-bottom border-secondary">
            <h5 class="mb-0">Portfolio Overview</h5>
            <div class="status-ribbon verified">
                <i data-feather="trending-up" class="icon-inline-sm"></i>
                Live Data
            </div>
        </div>
        
        <div class="row g-0">
            <div class="col-md-3">
                <div class="subcomponent-glass-element p-4 h-100 border-end border-secondary">
                    <div class="metric-value" id="total-reserves">$38,126.50</div>
                    <div class="metric-label">Total Reserves</div>
                    <div class="progress-with-action mt-2">
                        <div class="next-action">
                            <span class="status-ribbon verified">USD</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="subcomponent-glass-element p-4 h-100 border-end border-secondary">
                    <div class="metric-value text-success" id="verified-assets">$2.1M</div>
                    <div class="metric-label">Verified Assets</div>
                    <div class="progress-with-action mt-2">
                        <div class="next-action">
                            <span class="status-ribbon verified">Real Estate</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="subcomponent-glass-element p-4 h-100 border-end border-secondary">
                    <div class="metric-value text-warning" id="active-contracts">12</div>
                    <div class="metric-label">Active Contracts</div>
                    <div class="progress-with-action mt-2">
                        <div class="next-action">
                            <span class="status-ribbon processing">Live</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="subcomponent-glass-element p-4 h-100">
                    <div class="metric-value text-info" id="daily-rewards">0.318</div>
                    <div class="metric-label">Daily Rewards</div>
                    <div class="progress-with-action mt-2">
                        <div class="next-action">
                            <span class="status-ribbon verified">ODIS</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Featured Asset Showcase - Liquid Glass Panel -->
    <div class="component-glass-panel mb-4">
        <div class="d-flex justify-content-between align-items-center p-3 border-bottom border-secondary">
            <div>
                <h5 class="mb-0">
                    <i data-feather="zap" class="icon-inline text-warning"></i>
                    Featured Investment Opportunity
                </h5>
                <small class="text-muted">AI-recommended asset with completed due diligence</small>
            </div>
            <div class="status-ribbon verified">
                <i data-feather="shield" class="icon-inline-sm"></i>
                VERIFIED
            </div>
        </div>
        
        <div class="row g-0">
            <div class="col-md-4">
                <div class="subcomponent-glass-element p-4 h-100 border-end border-secondary">
                    <div class="asset-preview">
                        <div class="model-name h6 mb-3">Ithaca Project</div>
                        <div class="model-meta mb-3">
                            <div class="small text-muted mb-1">
                                <i data-feather="layers" class="icon-inline-sm"></i>
                                Due Diligence: 3 years
                            </div>
                            <div class="small text-muted mb-1">
                                <i data-feather="check-circle" class="icon-inline-sm"></i>
                                SPV Verified
                            </div>
                            <div class="small text-muted">
                                <i data-feather="shield" class="icon-inline-sm"></i>
                                Hard Asset
                            </div>
                        </div>
                        <button class="btn btn-sm btn-outline-info w-100">
                            <i data-feather="external-link" class="icon-inline-sm"></i>
                            View in 3D
                        </button>
                    </div>
                </div>
            </div>
            <div class="col-md-8">
                <div class="subcomponent-glass-element p-4 h-100">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="metric-small">
                                <div class="metric-value text-success">$1,625,000</div>
                                <div class="metric-label">Funded</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="metric-small">
                                <div class="metric-value">$2,500,000</div>
                                <div class="metric-label">Target</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="progress-with-action mt-3">
                        <div class="progress-bar-glass">
                            <div class="progress-fill" style="width: 65%"></div>
                        </div>
                        <div class="d-flex justify-content-between align-items-center mt-2">
                            <div class="next-action">
                                <i data-feather="trending-up" class="icon-inline-sm"></i>
                                65% funded - High demand
                            </div>
                            <button class="btn btn-success btn-sm">
                                <i data-feather="dollar-sign" class="icon-inline-sm"></i>
                                Invest Now
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- AI-Driven Insights Panel -->
    <div class="component-glass-panel mb-4">
        <div class="d-flex justify-content-between align-items-center p-3 border-bottom border-secondary">
            <h5 class="mb-0">
                <i data-feather="brain" class="icon-inline"></i>
                AI-Driven Insights & Recommendations
            </h5>
            <div class="status-ribbon processing">
                <i data-feather="activity" class="icon-inline-sm"></i>
                Live Analysis
            </div>
        </div>
        
        <div class="row g-0">
            <div class="col-md-8">
                <div class="subcomponent-glass-element p-4 h-100 border-end border-secondary">
                    <div class="ai-insights-feed" id="ai-insights-feed">
                        <div class="insight-item mb-3">
                            <div class="d-flex align-items-start">
                                <div class="insight-icon text-success me-3">
                                    <i data-feather="trending-up"></i>
                                </div>
                                <div class="insight-content">
                                    <div class="insight-title">Portfolio Optimization Opportunity</div>
                                    <div class="insight-description">Consider increasing ODIS staking to maximize APY returns. Current stake utilization: 65%</div>
                                    <div class="insight-actions mt-2">
                                        <button class="btn btn-sm btn-outline-success">
                                            <i data-feather="arrow-up" class="icon-inline-sm"></i>
                                            Optimize Now
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="insight-item mb-3">
                            <div class="d-flex align-items-start">
                                <div class="insight-icon text-warning me-3">
                                    <i data-feather="alert-triangle"></i>
                                </div>
                                <div class="insight-content">
                                    <div class="insight-title">Contract Action Required</div>
                                    <div class="insight-description">2 contracts pending signature. Estimated completion time: 24 hours</div>
                                    <div class="insight-actions mt-2">
                                        <button class="btn btn-sm btn-outline-warning" onclick="window.location.href='/contracts'">
                                            <i data-feather="file-text" class="icon-inline-sm"></i>
                                            Review Contracts
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="insight-item">
                            <div class="d-flex align-items-start">
                                <div class="insight-icon text-info me-3">
                                    <i data-feather="target"></i>
                                </div>
                                <div class="insight-content">
                                    <div class="insight-title">Market Opportunity</div>
                                    <div class="insight-description">Ithaca Project funding at 65% - high demand detected. Consider increasing allocation</div>
                                    <div class="insight-actions mt-2">
                                        <button class="btn btn-sm btn-outline-info" data-bs-toggle="modal" data-bs-target="#investModal">
                                            <i data-feather="dollar-sign" class="icon-inline-sm"></i>
                                            Invest Now
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="subcomponent-glass-element p-4 h-100">
                    <h6 class="mb-3">Performance Metrics</h6>
                    <div class="metric-small mb-3">
                        <div class="metric-value text-success" id="portfolio-growth">+12.5%</div>
                        <div class="metric-label">30-Day Growth</div>
                    </div>
                    <div class="metric-small mb-3">
                        <div class="metric-value text-info" id="ai-score">87/100</div>
                        <div class="metric-label">AI Optimization Score</div>
                    </div>
                    <div class="metric-small">
                        <div class="metric-value text-warning" id="risk-level">Low</div>
                        <div class="metric-label">Risk Assessment</div>
                    </div>
                    
                    <div class="progress-with-action mt-4">
                        <div class="progress-bar-glass">
                            <div class="progress-fill" style="width: 87%"></div>
                        </div>
                        <div class="next-action">
                            <i data-feather="shield" class="icon-inline-sm"></i>
                            Portfolio optimized
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Investment Modal -->
<div class="modal fade" id="investModal" tabindex="-1" aria-labelledby="investModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content bg-dark text-light border-info">
            <div class="modal-header border-info">
                <h5 class="modal-title" id="investModalLabel">
                    <i data-feather="dollar-sign" class="icon-inline text-info"></i>
                    Invest in Ithaca Project
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="investmentAmount" class="form-label">Investment Amount (ODIS)</label>
                    <input type="number" class="form-control bg-dark text-light border-info" id="investmentAmount" placeholder="Enter amount">
                </div>
                <div class="mb-3">
                    <label for="walletAddress" class="form-label">Wallet Address</label>
                    <div class="input-group">
                        <input type="text" class="form-control bg-dark text-light border-info" id="walletAddress" value="0x71C...9E3f" readonly>
                        <button class="btn btn-outline-info" type="button">
                            <i data-feather="copy" class="icon-inline-sm"></i>
                        </button>
                    </div>
                </div>
                <div class="alert alert-info">
                    <i data-feather="info" class="icon-inline-sm"></i>
                    This investment will be automatically staked, earning 9.5% APY.
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="spvKycCheck">
                    <label class="form-check-label" for="spvKycCheck">
                        I confirm this asset has passed SPV/KYC verification
                    </label>
                </div>
            </div>
            <div class="modal-footer border-info">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-info" id="investModalConnectBtn">
                    <i data-feather="link" class="icon-inline-sm"></i>
                    Connect Keplr Wallet
                </button>
                <button type="button" class="btn btn-success d-none" id="investModalProceedBtn">
                    <i data-feather="check-circle" class="icon-inline-sm"></i>
                    Proceed with Investment
                </button>
            </div>
        </div>
    </div>
</div>

<!-- AI Assistant Modal -->
<div class="modal fade" id="aiAssistantModal" tabindex="-1" aria-labelledby="aiAssistantModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content bg-dark text-light border-secondary">
            <div class="modal-header border-secondary">
                <h5 class="modal-title" id="aiAssistantModalLabel">
                    <i data-feather="cpu" class="icon-inline text-secondary"></i>
                    AI Contract Assistant
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-4">
                        <div class="nav flex-column nav-pills" id="contract-steps-tab" role="tablist">
                            <button class="nav-link active" id="step1-tab" data-bs-toggle="pill" data-bs-target="#step1" type="button" role="tab">1. Asset Information</button>
                            <button class="nav-link" id="step2-tab" data-bs-toggle="pill" data-bs-target="#step2" type="button" role="tab">2. IFC Validation</button>
                            <button class="nav-link" id="step3-tab" data-bs-toggle="pill" data-bs-target="#step3" type="button" role="tab">3. Stakeholder Details</button>
                            <button class="nav-link" id="step4-tab" data-bs-toggle="pill" data-bs-target="#step4" type="button" role="tab">4. Contract Terms</button>
                            <button class="nav-link" id="step5-tab" data-bs-toggle="pill" data-bs-target="#step5" type="button" role="tab">5. Keplr Signatures</button>
                        </div>
                    </div>
                    <div class="col-md-8">
                        <div class="tab-content p-3" id="contract-steps-content">
                            <div class="tab-pane fade show active" id="step1" role="tabpanel">
                                <h6 class="mb-3 text-info">Asset Information</h6>
                                <p>Enter the core details about your real estate asset. The AI will auto-populate fields from your IFC file once uploaded.</p>
                                <div class="mb-3">
                                    <label class="form-label">Asset Name</label>
                                    <input type="text" class="form-control bg-dark text-light border-secondary">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Location</label>
                                    <input type="text" class="form-control bg-dark text-light border-secondary">
                                </div>
                            </div>
                            <div class="tab-pane fade" id="step2" role="tabpanel">
                                <h6 class="mb-3 text-info">IFC Validation</h6>
                                <p>Upload your IFC file for analysis. Our AI will validate the building information and calculate the estimated asset value.</p>
                                <div class="mb-3">
                                    <label class="form-label">Upload IFC File</label>
                                    <input type="file" class="form-control bg-dark text-light border-secondary">
                                </div>
                            </div>
                            <div class="tab-pane fade" id="step3" role="tabpanel">
                                <h6 class="mb-3 text-info">Stakeholder Details</h6>
                                <p>Define the stakeholders for this asset. These will be encoded in the smart contract.</p>
                                <div class="mb-3">
                                    <label class="form-label">Stakeholder Wallet Addresses</label>
                                    <textarea class="form-control bg-dark text-light border-secondary" rows="3"></textarea>
                                </div>
                            </div>
                            <div class="tab-pane fade" id="step4" role="tabpanel">
                                <h6 class="mb-3 text-info">Contract Terms</h6>
                                <p>Review and modify the smart contract terms generated by our AI.</p>
                                <div class="mb-3">
                                    <label class="form-label">Token Name & Symbol</label>
                                    <div class="input-group">
                                        <input type="text" class="form-control bg-dark text-light border-secondary" placeholder="Name">
                                        <input type="text" class="form-control bg-dark text-light border-secondary" placeholder="Symbol">
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Total Supply</label>
                                    <input type="number" class="form-control bg-dark text-light border-secondary">
                                </div>
                            </div>
                            <div class="tab-pane fade" id="step5" role="tabpanel">
                                <h6 class="mb-3 text-info">Keplr Signatures</h6>
                                <p>Final step: Collect multisig approvals from all stakeholders using Keplr wallet.</p>
                                <div class="alert alert-warning">
                                    <i data-feather="alert-triangle" class="icon-inline-sm"></i>
                                    Remember: NFTs can only be minted after the asset has passed due diligence.
                                </div>
                                <button class="btn btn-info">
                                    <i data-feather="link" class="icon-inline-sm"></i>
                                    Connect Keplr for Signing
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-secondary">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-info" id="getAIAdviceBtn">
                    <i data-feather="cpu" class="icon-inline-sm"></i>
                    Get AI Advice
                </button>
            </div>
        </div>
    </div>
</div>

{% block extra_js %}
<script>
/**
 * Dashboard AI Brain Integration
 * Connects the liquid glass UI to the AI orchestrator and real data
 */

class DashboardBrainInterface {
    constructor() {
        this.orchestrator = window.DaodiseoOrchestrator;
        this.neuralConnections = [];
        this.charts = {};
        this.init();
    }
    
    init() {
        // Wait for orchestrator to initialize
        this.orchestrator.on('orchestrator:initialized', () => {
            this.setupNeuralConnections();
            this.initializeCharts();
            this.bindDataUpdates();
            this.startRealTimeUpdates();
        });
        
        // Setup event listeners for AI insights
        this.orchestrator.on('ai:insights:updated', (insights) => {
            this.updateInsightsUI(insights);
        });
        
        // Setup state change listeners
        this.orchestrator.on('state:blockchain:updated', (data) => {
            this.updateTokenMetrics(data);
        });
        
        this.orchestrator.on('state:assets:updated', (data) => {
            this.updateAssetDistribution(data);
        });
        
        this.orchestrator.on('state:transactions:updated', (data) => {
            this.updateRecentActivity(data);
        });
    }
    
    setupNeuralConnections() {
        const brainContainer = document.getElementById('neuralConnections');
        const satellites = document.querySelectorAll('.satellite-component');
        
        satellites.forEach((satellite, index) => {
            const connection = document.createElement('div');
            connection.className = 'neural-connection';
            connection.style.cssText = `
                top: 50%;
                left: 50%;
                width: ${100 + index * 20}px;
                transform: rotate(${index * 90}deg);
                animation-delay: ${index * 0.5}s;
            `;
            brainContainer.appendChild(connection);
            this.neuralConnections.push(connection);
        });
        
        // Add data flow animations
        this.createDataFlowLines();
    }
    
    createDataFlowLines() {
        const satellites = document.querySelectorAll('.satellite-component');
        satellites.forEach((satellite, index) => {
            const flowLine = document.createElement('div');
            flowLine.className = 'data-flow-line';
            flowLine.style.cssText = `
                top: 50%;
                left: 50%;
                width: ${150 + index * 30}px;
                transform: rotate(${45 + index * 90}deg);
                animation-delay: ${index * 0.8}s;
            `;
            satellite.appendChild(flowLine);
        });
    }
    
    initializeCharts() {
        // Asset Distribution Chart
        const assetCtx = document.getElementById('asset-distribution-chart');
        if (assetCtx) {
            this.charts.assetDistribution = new Chart(assetCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Verified Assets', 'Pipeline Assets'],
                    datasets: [{
                        data: [24250000, 13876500],
                        backgroundColor: ['#28a745', '#ffc107'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        }
    }
    
    bindDataUpdates() {
        // Bind satellite components to real data
        const tokenSatellite = document.querySelector('[data-satellite="token"]');
        const assetsSatellite = document.querySelector('[data-satellite="assets"]');
        const validatorsSatellite = document.querySelector('[data-satellite="validators"]');
        const transactionsSatellite = document.querySelector('[data-satellite="transactions"]');
        
        // Add click handlers for navigation
        tokenSatellite?.addEventListener('click', () => this.highlightComponent('token'));
        assetsSatellite?.addEventListener('click', () => this.highlightComponent('assets'));
        validatorsSatellite?.addEventListener('click', () => this.highlightComponent('validators'));
        transactionsSatellite?.addEventListener('click', () => this.highlightComponent('transactions'));
    }
    
    highlightComponent(componentType) {
        // Add pulse animation to highlight interactions
        const component = document.querySelector(`[data-satellite="${componentType}"]`);
        if (component) {
            component.classList.add('glass-active-pulse', 'active');
            setTimeout(() => {
                component.classList.remove('glass-active-pulse', 'active');
            }, 1000);
        }
        
        // Update AI insights based on component interaction
        this.orchestrator.emit('component:interaction', { type: componentType });
    }
    
    updateTokenMetrics(blockchainData) {
        // Update ODIS token metrics with real data
        const elements = {
            'token-price': blockchainData.tokenPrice ? `$${blockchainData.tokenPrice.toFixed(4)}` : '$0.1214',
            'price-change': blockchainData.priceChange ? `${blockchainData.priceChange > 0 ? '+' : ''}${blockchainData.priceChange.toFixed(2)}%` : '+3.68%',
            'market-cap': blockchainData.marketCap ? `$${(blockchainData.marketCap / 1000000).toFixed(1)}M` : '$12.4M',
            'staking-apy': blockchainData.stakingApy ? `${blockchainData.stakingApy.toFixed(1)}%` : '9.5%'
        };
        
        Object.entries(elements).forEach(([id, value]) => {
            const element = document.getElementById(id);
            if (element) {
                element.textContent = value;
                element.classList.add('will-change-opacity');
                element.style.opacity = '0.7';
                setTimeout(() => {
                    element.style.opacity = '1';
                    element.classList.remove('will-change-opacity');
                }, 200);
            }
        });
    }
    
    updateAssetDistribution(assetsData) {
        // Update asset distribution with real data
        const verifiedValue = document.getElementById('verified-assets-value');
        const pendingValue = document.getElementById('pending-assets-value');
        
        if (verifiedValue && assetsData.verified) {
            const totalVerified = assetsData.verified.reduce((sum, asset) => sum + (asset.value || 0), 0);
            verifiedValue.textContent = `$${(totalVerified / 1000000).toFixed(1)}M`;
        }
        
        if (pendingValue && assetsData.pending) {
            const totalPending = assetsData.pending.reduce((sum, asset) => sum + (asset.value || 0), 0);
            pendingValue.textContent = `$${(totalPending / 1000000).toFixed(1)}M`;
        }
        
        // Update chart if it exists
        if (this.charts.assetDistribution && assetsData.verified && assetsData.pending) {
            const verifiedTotal = assetsData.verified.reduce((sum, asset) => sum + (asset.value || 0), 0);
            const pendingTotal = assetsData.pending.reduce((sum, asset) => sum + (asset.value || 0), 0);
            
            this.charts.assetDistribution.data.datasets[0].data = [verifiedTotal, pendingTotal];
            this.charts.assetDistribution.update('none');
        }
    }
    
    updateRecentActivity(transactionsData) {
        const container = document.getElementById('recent-transactions');
        if (container && transactionsData.recent) {
            // Update with real transaction data
            const transactionItems = transactionsData.recent.slice(0, 3).map(tx => `
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <div class="d-flex align-items-center">
                        <div class="status-indicator ${tx.status === 'completed' ? 'active' : 'jailed'} me-2"></div>
                        <span class="small">${tx.type || 'Transaction'}</span>
                    </div>
                    <span class="small ${tx.amount > 0 ? 'text-success' : 'text-warning'}">
                        ${tx.amount > 0 ? '+' : ''}${tx.amount} ODIS
                    </span>
                </div>
            `).join('');
            
            container.innerHTML = transactionItems;
        }
    }
    
    updateInsightsUI(insights) {
        const container = document.getElementById('ai-insights-feed');
        if (container && insights.length > 0) {
            const insightsHtml = insights.map(insight => `
                <div class="insight-item mb-3">
                    <div class="d-flex align-items-start">
                        <div class="insight-icon text-${insight.priority === 'high' ? 'warning' : insight.priority === 'medium' ? 'info' : 'success'} me-3">
                            <i data-feather="${insight.type.includes('contract') ? 'file-text' : insight.type.includes('staking') ? 'trending-up' : 'target'}"></i>
                        </div>
                        <div class="insight-content">
                            <div class="insight-title">${insight.message}</div>
                            <div class="insight-description">${insight.action}</div>
                            <div class="insight-actions mt-2">
                                <button class="btn btn-sm btn-outline-${insight.priority === 'high' ? 'warning' : 'info'}" onclick="window.location.href='${insight.route}'">
                                    <i data-feather="arrow-right" class="icon-inline-sm"></i>
                                    Take Action
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
            
            container.innerHTML = insightsHtml;
            
            // Re-initialize feather icons
            if (typeof feather !== 'undefined') {
                feather.replace();
            }
        }
    }
    
    startRealTimeUpdates() {
        // Start periodic updates for dashboard metrics
        setInterval(() => {
            this.orchestrator.refreshCriticalData();
        }, 10000); // Update every 10 seconds
        
        // Update portfolio metrics
        setInterval(() => {
            this.updatePortfolioMetrics();
        }, 30000); // Update every 30 seconds
    }
    
    updatePortfolioMetrics() {
        const state = this.orchestrator.getState();
        
        // Update portfolio overview
        const totalReserves = document.getElementById('total-reserves');
        const verifiedAssets = document.getElementById('verified-assets');
        const activeContracts = document.getElementById('active-contracts');
        const dailyRewards = document.getElementById('daily-rewards');
        
        if (totalReserves && state.assets.totalValue) {
            totalReserves.textContent = `$${state.assets.totalValue.toLocaleString()}`;
        }
        
        if (verifiedAssets && state.assets.verified) {
            const verifiedCount = state.assets.verified.length;
            const verifiedValue = state.assets.verified.reduce((sum, asset) => sum + (asset.value || 0), 0);
            verifiedAssets.textContent = `$${(verifiedValue / 1000000).toFixed(1)}M`;
        }
        
        if (activeContracts && state.contracts.active) {
            activeContracts.textContent = state.contracts.active.length.toString();
        }
        
        if (dailyRewards) {
            const rewards = this.orchestrator.calculateDailyRewards();
            dailyRewards.textContent = rewards;
        }
    }
}

// Initialize dashboard when DOM is ready
document.addEventListener('DOMContentLoaded', function() {
    // Initialize feather icons
    if (typeof feather !== 'undefined') {
        feather.replace();
    }
    
    // Initialize Chart.js if available
    if (typeof Chart !== 'undefined') {
        Chart.defaults.color = '#ffffff';
        Chart.defaults.borderColor = 'rgba(255, 255, 255, 0.1)';
    }
    
    // Initialize dashboard brain interface
    if (window.DaodiseoOrchestrator) {
        window.dashboardBrain = new DashboardBrainInterface();
    } else {
        console.warn('DaodiseoOrchestrator not available');
    }
    
    // Setup investment modal handlers
    const investModal = document.getElementById('investModal');
    if (investModal) {
        const connectBtn = document.getElementById('investModalConnectBtn');
        const proceedBtn = document.getElementById('investModalProceedBtn');
        
        connectBtn?.addEventListener('click', function() {
            // Use existing wallet connection logic
            if (typeof connectKeplrWallet === 'function') {
                connectKeplrWallet().then(() => {
                    connectBtn.classList.add('d-none');
                    proceedBtn.classList.remove('d-none');
                });
            }
        });
    }
});
</script>

<!-- Chart.js for visualizations -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block extra_js %}
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- Custom Scripts -->
<script src="{{ url_for('static', filename='js/ai-chat-enhanced.js') }}"></script>
<script src="{{ url_for('static', filename='js/bim-viewer.js') }}"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize AI Chat
        aiChat.init('ai-chat-container');

        // Initialize mini BIM viewer
        bimViewer.init('mini-viewer-container');

        // Initialize asset distribution chart
        const assetCtx = document.getElementById('asset-distribution-chart').getContext('2d');
        const assetChart = new Chart(assetCtx, {
            type: 'doughnut',
            data: {
                labels: ['Verified Assets', 'Unverified Assets'],
                datasets: [{
                    data: [65, 35],
                    backgroundColor: [
                        'rgba(0, 153, 7, 0.7)',    // success
                        'rgba(243, 192, 0, 0.7)',  // warning
                    ],
                    borderColor: 'rgba(255, 255, 255, 0.1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            color: 'rgba(255, 255, 255, 0.7)'
                        }
                    }
                }
            }
        });

        // Initialize stakeholder chart
        const stakeholderCtx = document.getElementById('stakeholder-chart').getContext('2d');
        const stakeholderChart = new Chart(stakeholderCtx, {
            type: 'doughnut',
            data: {
                labels: ['Institutional Investors', 'Private Investors', 'Developer Equity', 'Reserved Pool'],
                datasets: [{
                    data: [45, 25, 20, 10],
                    backgroundColor: [
                        'rgba(224, 13, 121, 0.7)',  // info
                        'rgba(184, 5, 150, 0.7)',   // secondary
                        'rgba(0, 153, 7, 0.7)',     // success
                        'rgba(243, 192, 0, 0.7)'    // warning
                    ],
                    borderColor: 'rgba(255, 255, 255, 0.1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'right',
                        labels: {
                            color: 'rgba(255, 255, 255, 0.7)'
                        }
                    }
                }
            }
        });

        // Check wallet connection when investment modal is opened
        document.getElementById('investModal').addEventListener('show.bs.modal', function() {
            // Check if wallet is connected (using localStorage)
            const walletConnected = localStorage.getItem('walletConnected') === 'true';
            const userWalletAddress = localStorage.getItem('userWalletAddress');

            // Update wallet address field if available
            if (walletConnected && userWalletAddress) {
                document.getElementById('walletAddress').value = userWalletAddress;

                // Show the proceed button, hide the connect button
                document.getElementById('investModalConnectBtn').classList.add('d-none');
                document.getElementById('investModalProceedBtn').classList.remove('d-none');
            } else {
                // Show the connect button, hide the proceed button
                document.getElementById('investModalConnectBtn').classList.remove('d-none');
                document.getElementById('investModalProceedBtn').classList.add('d-none');
            }
        });

        // Invest modal wallet connection button
        document.getElementById('investModalConnectBtn').addEventListener('click', function() {
            // Access the main wallet connection function from base.html
            connectKeplrWallet();

            // Close the investment modal
            const investModal = bootstrap.Modal.getInstance(document.getElementById('investModal'));
            if (investModal) {
                investModal.hide();
            }
        });

        // Proceed with investment button
        document.getElementById('investModalProceedBtn').addEventListener('click', function() {
            // Get investment amount
            const amount = document.getElementById('investmentAmount').value;

            if (!amount || isNaN(amount) || parseFloat(amount) <= 0) {
                alert('Please enter a valid investment amount.');
                return;
            }

            // Check if SPV/KYC confirmation is checked
            const spvKycChecked = document.getElementById('spvKycCheck').checked;
            if (!spvKycChecked) {
                alert('Please confirm SPV/KYC verification.');
                return;
            }

            // Process investment
            alert(`Processing investment of ${amount} ODIS. Transaction will be signed with your Keplr wallet.`);

            // Close modal after successful transaction
            const investModal = bootstrap.Modal.getInstance(document.getElementById('investModal'));
            if (investModal) {
                investModal.hide();
            }
        });

        // Open AI Assistant modal button
        document.body.addEventListener('click', function(e) {
            if (e.target.matches('[data-ai-assistant]') || e.target.closest('[data-ai-assistant]')) {
                new bootstrap.Modal(document.getElementById('aiAssistantModal')).show();
            }
        });

        // Initialize tooltips
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl)
        });

        // Update feather icons
        feather.replace();
    });
</script>
{% endblock %}